<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Барная карта</title>
  <!-- Подключаем статические файлы -->
  {% load static %}
  <!-- Подключаем Bootstrap CSS из CDN -->
  <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
  <!-- Подключаем кастомный CSS, лежащий в статике -->
  <link href="{% static 'css_restourant\restourant_drink.css' %}"></link>
  <!-- Иконка сайта -->
  <link rel="icon" href="{% static 'img_restourant/free-icon-restaurant-562678.png' %}">
  <style>
    /* Стили для хедера */
    #header_block{
      display: flex;
      justify-content: center;
    }
    .link_header_item{
      padding: 5px;
      text-decoration: none;
      cursor: pointer;
      color:#F2F4F3;
      font-size: 22px;
    }
    .link_header_item:hover{
      text-decoration: underline #F2F4F3;
      text-decoration-thickness: 1.5px;
      text-underline-offset: 10px;
      transition: 0.7s;
    }
    .header{
      background-color: #0A0908;
      margin: 0;
      padding: 0;
    }
    body{
      margin: 0;
      background-color: #F2F4F3;
      color:#0A0908;
      padding: 0;
      font-family: 'Courier New', Courier, monospace;
    }
  </style>
</head>
<body>
  {% load static %}
  <!-- Хедер сайта с навигацией -->
  <header class="header p-3 sticky-top" id="header">
    <div class="container-fluid">
      <div class="row">
        <div class="text-center col-12">
          <!-- Ссылки навигации с использованием Django url тегов -->
          <a class="link_header_item mx-3 p-2" href="{% url 'home' %}">Главная</a>
          <a class="link_header_item mx-3 p-2" href="{% url 'menu' %}">Меню</a>
          <a class="link_header_item mx-3 p-2" href="{% url 'about' %}">Обращение</a>
          <a class="link_header_item mx-3 p-2" href="{% url 'rate' %}">Оценить нас</a>
          <a class="link_header_item mx-3 p-2" href="#footer">Контакты</a>
        </div>
      </div>
    </div>
  </header>
  <!-- Основной контейнер для вывода карточек напитков -->
  <main>
    <div class="container" id="container">
    </div>
  </main>
  <!-- Футер с информацией о времени работы и контактах -->
  <div class="container-fluid mt-5" style="background-color: #0A0908; color:#F2F4F3;" id="div_footer">
      <div class="row" style="display: flex; justify-content: space-around;">
        <div class="col-sm-12 col-md-6 col-lg-6 text-center mt-4 pb-3">
          <h4>Время работы</h4>
          <p>Понедельник-Пятница: с 9:00 до 21:00<br>
            Суббота: с 10:00 до 20:00<br>
            Воскресенье: с 10:00 до 18:00</p>
        </div>
        <div class="col-sm-12 col-md-6 col-lg-6 text-center mt-4 pb-3" style="margin-bottom: 50px;">
          <h4>Контакты</h4>
          <p>+7 (995) 792-67-95<br>+7 (986) 792-67-95<br>nirzzii@mail.ru</p>
          <a href="https://t.me/nirzzii"><img src="{% static 'img_restourant/icons/Иконка_телеграм.png' %}" alt="телеграм" height="40px"  width="40px"></a>
        </div>
        </div>
      </div>
    </div>
  <!-- Подключаем Bootstrap JS для работы компонентов -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
  <script>
    // Получаем контейнер, куда будем вставлять карточки напитков
    const mainContainer = document.getElementById('container')
    // Асинхронная функция для получения количества напитков из БД
    async function getDrinkCount(){
      const responce = await fetch('/get_drink_count/'); // Получаем JSON с количеством
      const data = await responce.json();
      return data.count;
    }
    // Главная функция для загрузки всех напитков и отображения по категориям
    async function AllDrink() {
      const count = await getDrinkCount();
      const categories = {}; // Объект для хранения контейнеров категорий, чтобы не дублировать

      // Цикл по всем ID напитков от 1 до count
      for (var drinkid = 1; drinkid <= count; drinkid++) {
        const url = `/get-drink/${drinkid}/`; // URL для получения данных конкретного напитка
        await getDrink(url, categories); // Загрузка и отрисовка карточки напитка
      }
    }
    // Функция загрузки данных напитка и создание карточки
    async function getDrink(url, categories) {
      const response = await fetch(url);
      const data = await response.json();
      console.log(data); // Для отладки выводим полученные данные в консоль

    
      
      const categoryKey = data.drink_type_select; // Определяем категорию напитка (ключ из БД)
      let categoryDiv = categories[categoryKey]; // Ищем уже созданный блок для этой категории
      
      // Если такого блока ещё нет — создаём новый контейнер для категории
      if (!categoryDiv) {
        categoryDiv = document.createElement('div');
        categoryDiv.className = "row px-2 mt-5";
        categoryDiv.style.display = 'flex';
        categoryDiv.style.flexWrap = 'wrap'; // Позволяет карточкам переходить на новую строку
        categoryDiv.style.justifyContent = 'space-around';
        categoryDiv.style.marginTop = '20px';
    
        // Создаём заголовок категории
        const h2 = document.createElement('h2');
        h2.textContent = getCategoryName(categoryKey); // Читаемое название категории по ключу
        categoryDiv.appendChild(h2);
    
        // Добавляем категорию в основной контейнер
        mainContainer.appendChild(categoryDiv);
    
        // Сохраняем в объект категорий
        categories[categoryKey] = categoryDiv;
      }
    
      // Создаём карточку напитка (Bootstrap card)
      const cardDiv = document.createElement('div');
      cardDiv.className = "card mb-3";
      cardDiv.style.maxWidth = '540px';
      cardDiv.style.margin = '10px';
      
      // Внутри карточки создаём строку (row)
      const row = document.createElement('div');
      row.className = 'row g-0';
      cardDiv.appendChild(row);
      
      // Левая часть с изображением (4 колонки)
      const colImg = document.createElement('div');
      colImg.className = 'col-md-4';
      row.appendChild(colImg);
    
      const img = document.createElement('img');
      img.className = 'img-fluid rounded-start w-100 h-100';
      img.style.objectFit = 'cover'; // Изображение обрезается по размеру контейнера
      img.alt = data.name;
      img.src = data.image_drink;
      colImg.appendChild(img);
      
      // Правая часть с информацией (8 колонок)
      const colContent = document.createElement('div');
      colContent.className = 'col-md-8';
      row.appendChild(colContent);
      
      const cardBody = document.createElement('div');
      cardBody.className = 'card-body';
      colContent.appendChild(cardBody);
      
      // Название напитка жирным
      const h5 = document.createElement('h5');
      h5.className = 'card-title';
      h5.style.fontWeight = 'bold';
      h5.textContent = data.name;
      cardBody.appendChild(h5);
      
      // Описание напитка
      const pDescription = document.createElement('p');
      pDescription.className = 'card-text';
      pDescription.textContent = data.description_drink;
      cardBody.appendChild(pDescription);
      
      // Цена напитка
      const pPrice = document.createElement('p');
      pPrice.className = 'card-text';
      pPrice.style.fontWeight = 'bold';
    
      const small = document.createElement('small');
      small.style.fontSize = '20px';
      small.className = 'text-body-secondary';
      small.textContent = `${data.price} рублей`;
      pPrice.appendChild(small);
      cardBody.appendChild(pPrice);
      
      // Кнопка "Подробнее" для показа дополнительной информации в offcanvas
      const button = document.createElement('button');
      button.className = 'btn btn-primary button_card_detail';
      button.type = 'button';
      // Устанавливаем id offcanvas и связываем кнопку с ним
      button.setAttribute('data-bs-toggle', 'offcanvas');
      const offcanvasId = 'offcanvasExample_' + data.name.replace(/\s/g, '_').toLowerCase();
      button.setAttribute('data-bs-target', '#' + offcanvasId);
      button.setAttribute('aria-controls', offcanvasId);
      button.textContent = 'Подробнее';
      cardBody.appendChild(button);
      
      // Добавляем карточку в блок категории
      categoryDiv.appendChild(cardDiv);
      
      // При клике по кнопке создаём и показываем offcanvas с детальной информацией
      button.addEventListener('click', function() {
        createOffcanvas(data);
      });
    }
    
    // Функция создания offcanvas (выдвижной боковой панели) с подробной информацией о напитке
    function createOffcanvas(data) {
      // Создаём уникальный id для offcanvas по названию напитка
      const offcanvasId = 'offcanvas_' + data.name.replace(/\s/g, '_').toLowerCase();
    
      // Проверяем, есть ли уже offcanvas с таким id, чтобы не дублировать
      let existingOffcanvas = document.getElementById(offcanvasId);
      if (!existingOffcanvas) {
        // Создаём контейнер offcanvas
        const offcanvasDiv = document.createElement('div');
        offcanvasDiv.className = 'offcanvas offcanvas-start';
        offcanvasDiv.setAttribute('tabindex', '-1');
        offcanvasDiv.id = offcanvasId;
        offcanvasDiv.setAttribute('aria-labelledby', 'offcanvasLabel_' + offcanvasId);
        
        // Заголовок offcanvas с кнопкой закрытия
        const offcanvasHeader = document.createElement('div');
        offcanvasHeader.className = 'offcanvas-header';

        const closeButton = document.createElement('button');
        closeButton.className = 'btn-close';
        closeButton.setAttribute('data-bs-dismiss', 'offcanvas');
        closeButton.setAttribute('aria-label', 'Close');
        offcanvasHeader.appendChild(closeButton);
        offcanvasDiv.appendChild(offcanvasHeader);
        
        // Основное тело offcanvas
        const offcanvasBody = document.createElement('div');
        offcanvasBody.className = 'offcanvas-body';
        
        // Создаем и настраиваем изображение напитка для offcanvas
        const imgOffcanvas = document.createElement('img');
        imgOffcanvas.src = data.image_drink;
        imgOffcanvas.className = 'img-fluid';
        imgOffcanvas.style.maxHeight = '300px'; // Ограничиваем высоту до 300px
        imgOffcanvas.style.width = 'auto'; // Автоматическая ширина для сохранения пропорций
        imgOffcanvas.style.display = 'block'; // Центрируем изображение
        imgOffcanvas.style.margin = '0 auto';
        imgOffcanvas.alt = data.name;
        offcanvasBody.appendChild(imgOffcanvas);
        
        // Заголовки для списков ингредиентов и калорий/веса
        const ingredientsHeader = document.createElement('h4');
        ingredientsHeader.textContent = 'Ингредиенты';
        const caloriesandweight = document.createElement('h4');
        caloriesandweight.textContent = 'Калории и масса';
        
        // Списки для ингредиентов и калорий/веса
        const ingredientsList = document.createElement('ul');
        const callandweight = document.createElement('ul');

        // Заполняем калории и вес, если данные есть
        if (Array.isArray(data.structure_drink.ingredients)) {
          for (var i = 0; i < data.structure_drink.ingredients.length; i++) {
            const li = document.createElement('li');
            li.textContent = `${data.structure_drink.ingredients[i].name}: ${data.structure_drink.ingredients[i].quantity}`;
            ingredientsList.appendChild(li);
          }
        } else {
          const li = document.createElement('li');
          li.textContent = 'Ингредиенты не найдены';
          ingredientsList.appendChild(li);
        }
    
        // Добавляем калории и вес
        if (data.structure_drink.callories_weight && Array.isArray(data.structure_drink.callories_weight)) {
          const li_callories = document.createElement('li');
          const li_weight = document.createElement('li');
          li_callories.textContent = `Калории: ${data.structure_drink.callories_weight[0].callories}`;
          li_weight.textContent = `Вес: ${data.structure_drink.callories_weight[0].weight}`;
          callandweight.appendChild(li_callories);
          callandweight.appendChild(li_weight);
        } else {
          const li = document.createElement('li');
          li.textContent = 'Калории и масса не найдены';
          callandweight.appendChild(li);
        }

// Добавляем список ингредиентов в тело offcanvas
offcanvasBody.appendChild(ingredientsHeader);
offcanvasBody.appendChild(ingredientsList);
offcanvasBody.appendChild(caloriesandweight);
offcanvasBody.appendChild(callandweight);
offcanvasDiv.appendChild(offcanvasBody);
document.body.appendChild(offcanvasDiv);
}

    
      // Инициализируем offcanvas после добавления в DOM
      const offcanvasElement = new bootstrap.Offcanvas(document.getElementById(offcanvasId));
      offcanvasElement.show();
    }
    // Функция для отображения названия категории по ключу
    function getCategoryName(key) {
      const categories = {
        'champagne': 'Шампанское и игристые вина',
        'beer': 'Пиво',
        'strong_drinks': 'Крепкие напитки',
        'cocktails': 'Коктейли',
        'non_alcoholic': 'Безалкогольные напитки',
      };
      return categories[key] || 'Прочие';
    }
    
    AllDrink();
  </script>
</body>
</html>